<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="作者：给立乐*出处：http://spencer-dev.com/2017/07/17/Clean Code - Chapter 14  逐步改进声明：本文采用以下协议进行授权： 自由转载-非商用-非衍生-保持署名|Creative Commons BY-NC-ND 3.0 ，转载请注明作者及出处。">
    

    <!--Author-->
    
        <meta name="author" content="Spencer">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Clean Code - Chapter 14  逐步改进"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="给立乐*"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Clean Code - Chapter 14  逐步改进 - 给立乐*</title>

    <!-- Bootstrap Core CSS -->
    <link href="http://7xjqw5.com1.z0.glb.clouddn.com/theme/css/bootstrap-3.3.6.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="http://7xjqw5.com1.z0.glb.clouddn.com/theme/css/font-awesome-4.6.3.min.css" rel="stylesheet" type="text/css">
    
    <!-- <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"> -->
    <link href="http://7xjqw5.com1.z0.glb.clouddn.com/theme/css/google-font-1.css" rel="stylesheet" type="text/css">
    
    <!-- <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"> -->
    <link href="http://7xjqw5.com1.z0.glb.clouddn.com/theme/css/google-font-2.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="http://7xjqw5.com1.z0.glb.clouddn.com/theme/css/featherlight-1.3.5.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-65158169-1', 'auto');
        ga('send', 'pageview');

    </script>



</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">给立乐* Android 开发者</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/ChinaSunHZ/">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('http://7xjqw5.com1.z0.glb.clouddn.com/theme/image/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Clean Code - Chapter 14  逐步改进</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        2017-07-17 01:23
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/Clean-Code/">#Clean Code</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>作者：给立乐*<br>出处：<a href="http://spencer-dev.com/2017/07/17/Clean Code - Chapter 14  逐步改进">http://spencer-dev.com/2017/07/17/Clean Code - Chapter 14  逐步改进</a><br>声明：本文采用以下协议进行授权： 自由转载-非商用-非衍生-保持署名|<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank" rel="external">Creative Commons BY-NC-ND 3.0</a> ，转载请注明作者及出处。</p>
<h1 id="逐步改进"><a href="#逐步改进" class="headerlink" title="逐步改进"></a>逐步改进</h1><p><em>这是对一个命令行参数解析程序的案例研究。这是一个逐步改进的过程。你将看到一开始还不错，规模扩大后即出现问题的模块。你还将看到这个模块是如何被重构的整洁起来的。</em></p>
<p>我们中的大多数人都会遇到解析命令行参数的情况。如果没有趁手的工具，就得遍历传入 main 函数的字符串数组。有一些不同来源的好工具，但没有一个是最符合要求的。所以，我当然要自己写一个。我把它叫做 Args。</p>
<p>Args 非常易于使用。你只要简单地用输入参数和格式化字符串构造 Args 类，再向 Args 实体询问参数值即可。看看下面的简单例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Argsarg = <span class="keyword">new</span> Args(<span class="string">"l, p#, d*"</span>, args);</div><div class="line">        <span class="keyword">boolean</span> logging = arg.getBoolean(<span class="string">'l'</span>);</div><div class="line">        intport = arg.getInt(<span class="string">'p'</span>);</div><div class="line">        Stringdirectory = arg.getString(<span class="string">'d'</span>);</div><div class="line">        executeApplication(logging, port, directory);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        System.out.printf(<span class="string">"Argumenterror:% s\n"</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这有多简单。我们只是用两个参数创建了 Args 类的一个实体。第一个参数是格式字符串，或范式字符串：1,p#,d*。它定义了三个命令行参数。第一个，-l，是一个布尔值参数。第二个，-p，是一个整数参数。第三个，-d，是一个字符串参数。向 Args 构造器传入的第二个参数就是向 main 传入的命令行参数数组。</p>
<p>如果构造器返回正常，没有抛出 ArgsException 异常，则命令行参数已传入，Args 实体随时待命。使用 getBoolean、getInteger、getString 等方法，可以用参数名称获得参数值。</p>
<p>不管是格式化字符串或命令行参数出现问题、就会抛出一个 ArgsException 异常。可以从该异常的 errorMessage 中获得关于错误的描述。</p>
<h2 id="Args-的实现"><a href="#Args-的实现" class="headerlink" title="Args 的实现"></a>Args 的实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers;</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound;</div><div class="line">    <span class="keyword">private</span> ListIterator&lt;String&gt; currentArgument;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">        argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</div><div class="line">        parseSchema(schema);</div><div class="line">        parseArgumentStrings(Arrays.asList(args));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchema</span><span class="params">(String schema)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>) parseSchemaElement(element.trim());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">        String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">        validateSchemaElementId(elementId);</div><div class="line">        <span class="keyword">if</span> (elementTail.length() == <span class="number">0</span>) marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"*"</span>)) marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"#"</span>)) marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"##"</span>)) marshalers.put(elementId, <span class="keyword">new</span> DoubleArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"[*]"</span>)) marshalers.put(elementId, <span class="keyword">new</span> StringArrayArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_ARGUMENT_FORMAT, elementId, elementTail);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_ARGUMENT_NAME, elementId, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgumentStrings</span><span class="params">(List&lt;String&gt; argsList)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (currentArgument = argsList.listIterator(); currentArgument.hasNext(); ) &#123;</div><div class="line">            String argString = currentArgument.next();</div><div class="line">            <span class="keyword">if</span> (argString.startsWith(<span class="string">"-"</span>)) &#123;</div><div class="line">                parseArgumentCharacters(argString.substring(<span class="number">1</span>));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                currentArgument.previous();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgumentCharacters</span><span class="params">(String argChars)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argChars.length(); i++) parseArgumentCharacter(argChars.charAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgumentCharacter</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">        <span class="keyword">if</span> (m == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, argChar, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            argsFound.add(argChar);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                m.set(currentArgument);</div><div class="line">            &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">                e.setErrorArgumentId(argChar);</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.contains(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">nextArgument</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> currentArgument.nextIndex();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> BooleanArgumentMarshaler.getValue(marshalers.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> StringArgumentMarshaler.getValue(marshalers.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> IntegerArgumentMarshaler.getValue(marshalers.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getDouble</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> DoubleArgumentMarshaler.getValue(marshalers.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String[] getStringArray(<span class="keyword">char</span> arg) &#123;</div><div class="line">        <span class="keyword">return</span> StringArrayArgumentMarshaler.getValue(marshalers.get(arg));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        booleanValue = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">getValue</span><span class="params">(ArgumentMarshaler am)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (am != <span class="keyword">null</span> &amp;&amp; am <span class="keyword">instanceof</span> BooleanArgumentMarshaler) <span class="keyword">return</span> ((BooleanArgumentMarshaler) am).booleanValue;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.NoSuchElementException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.MISSING_STRING;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stringValue = currentArgument.next();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(MISSING_STRING);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getValue</span><span class="params">(ArgumentMarshaler am)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (am != <span class="keyword">null</span> &amp;&amp; am <span class="keyword">instanceof</span> StringArgumentMarshaler) <span class="keyword">return</span> ((StringArgumentMarshaler) am).stringValue;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.NoSuchElementException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            intValue = Integer.parseInt(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.MISSING_INTEGER);</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_INTEGER, parameter);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">(ArgumentMarshaler am)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (am != <span class="keyword">null</span> &amp;&amp; am <span class="keyword">instanceof</span> IntegerArgumentMarshaler) <span class="keyword">return</span> ((IntegerArgumentMarshaler) am).intValue;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.OK;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = OK;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode, String errorParameter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode, <span class="keyword">char</span> errorArgumentId, String errorParameter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</div><div class="line">        <span class="keyword">this</span>.errorArgumentId = errorArgumentId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">getErrorArgumentId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> errorArgumentId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorArgumentId</span><span class="params">(<span class="keyword">char</span> errorArgumentId)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorArgumentId = errorArgumentId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorParameter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> errorParameter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorParameter</span><span class="params">(String errorParameter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> ErrorCode <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> errorCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorCode</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (errorCode) &#123;</div><div class="line">            <span class="keyword">case</span> OK:</div><div class="line">                <span class="keyword">return</span> <span class="string">"TILT: Should not get here."</span>;</div><div class="line">            <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c unexpected."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> MISSING_STRING:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>, errorArgumentId,</div><div class="line">                        errorParameter);</div><div class="line">            <span class="keyword">case</span> MISSING_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_DOUBLE:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects a double but was '%s'."</span>, errorArgumentId, errorParameter);</div><div class="line">            <span class="keyword">case</span> MISSING_DOUBLE:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find double parameter for -%c."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_ARGUMENT_NAME:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"'% c' is not a valid argument name."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_ARGUMENT_FORMAT:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"'% s' is not a valid argument format."</span>, errorParameter);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">        OK,</div><div class="line">        INVALID_ARGUMENT_FORMAT,</div><div class="line">        UNEXPECTED_ARGUMENT,</div><div class="line">        INVALID_ARGUMENT_NAME,</div><div class="line">        MISSING_STRING,</div><div class="line">        MISSING_INTEGER,</div><div class="line">        INVALID_INTEGER,</div><div class="line">        MISSING_DOUBLE,</div><div class="line">        INVALID_DOUBLE</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Args：草稿"><a href="#Args：草稿" class="headerlink" title="Args：草稿"></a>Args：草稿</h2><p>能工作，但却很烂的版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.text.ParseException;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String schema;</div><div class="line">    <span class="keyword">private</span> String[] args;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="keyword">new</span> TreeSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs = <span class="keyword">new</span> HashMap&lt;Character, Boolean&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, String&gt; stringArgs = <span class="keyword">new</span> HashMap&lt;Character, String&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, Integer&gt; intArgs = <span class="keyword">new</span> HashMap&lt;Character, Integer&gt;();</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentArgument;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">        OK,</div><div class="line">        MISSING_STRING,</div><div class="line">        MISSING_INTEGER, INVALID_INTEGER,</div><div class="line">        UNEXPECTED_ARGUMENT</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        <span class="keyword">this</span>.args = args;</div><div class="line">        valid = parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; args.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        parseSchema();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parseArguments();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                String trimmedElement = element.trim();</div><div class="line">                parseSchemaElement(trimmedElement);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">        String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">        validateSchemaElementId(elementId);</div><div class="line">        <span class="keyword">if</span> (isBooleanSchemaElement(elementTail)) parseBooleanSchemaElement(elementId);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isStringSchemaElement(elementTail)) parseStringSchemaElement(elementId);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isIntegerSchemaElement(elementTail)) &#123;</div><div class="line">            parseIntegerSchemaElement(elementId);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(String.format(<span class="string">"Argument: %c has invalid format: %s."</span>, elementId, elementTail), <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Bad character:"</span> + elementId + <span class="string">" in Args format: "</span> + schema, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        booleanArgs.put(elementId, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseIntegerSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        intArgs.put(elementId, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        stringArgs.put(elementId, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"*"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.length() == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntegerSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"#"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseArguments</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (currentArgument = <span class="number">0</span>; currentArgument &lt; args.length; currentArgument++) &#123;</div><div class="line">            String arg = args[currentArgument];</div><div class="line">            parseArgument(arg);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgument</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg.startsWith(<span class="string">"-"</span>)) parseElements(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElements</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arg.length(); i++)</div><div class="line">            parseElement(arg.charAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (setArgument(argChar)) argsFound.add(argChar);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            unexpectedArguments.add(argChar);</div><div class="line">            errorCode = ErrorCode.UNEXPECTED_ARGUMENT;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isBooleanArg(argChar)) setBooleanArg(argChar, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isStringArg(argChar)) setStringArg(argChar);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isIntArg(argChar)) setIntArg(argChar);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> intArgs.containsKey(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        currentArgument++;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = args[currentArgument];</div><div class="line">            intArgs.put(argChar, <span class="keyword">new</span> Integer(parameter));</div><div class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">            errorArgumentId = argChar;</div><div class="line">            errorCode = ErrorCode.MISSING_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">            errorArgumentId = argChar;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ErrorCode.INVALID_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        currentArgument++;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stringArgs.put(argChar, args[currentArgument]);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">            errorArgumentId = argChar;</div><div class="line">            errorCode = ErrorCode.MISSING_STRING;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringArgs.containsKey(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanArgs.put(argChar, value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanArgs.containsKey(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">cardinality</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.size();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="string">"-["</span> + schema + <span class="string">"]"</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (errorCode) &#123;</div><div class="line">            <span class="keyword">case</span> OK:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"TILT: Should not get here."</span>);</div><div class="line">            <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</div><div class="line">                <span class="keyword">return</span> unexpectedArgumentMessage();</div><div class="line">            <span class="keyword">case</span> MISSING_STRING:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>, errorArgumentId, errorParameter);</div><div class="line">            <span class="keyword">case</span> MISSING_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>, errorArgumentId);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">unexpectedArgumentMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        StringBuffer message = <span class="keyword">new</span> StringBuffer(<span class="string">"Argument( s) -"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : unexpectedArguments) &#123;</div><div class="line">            message.append(c);</div><div class="line">        &#125;</div><div class="line">        message.append(<span class="string">"unexpected."</span>);</div><div class="line">        <span class="keyword">return</span> message.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">falseIfNull</span><span class="params">(Boolean b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> b != <span class="keyword">null</span> &amp;&amp; b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">zeroIfNull</span><span class="params">(Integer i)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> i == <span class="keyword">null</span> ? <span class="number">0</span> : i;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">blankIfNull</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s == <span class="keyword">null</span> ? <span class="string">""</span> : s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> blankIfNull(stringArgs.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> zeroIfNull(intArgs.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> falseIfNull(booleanArgs.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.contains(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然上面这段代码还需要打磨。实体变量的数量多到吓人。诸如 TILT 之类奇怪的字符串， HashSet 和 TreeSet，还有那些 try-catch-catch 代码块，组成了一个烂摊子。</p>
<p>我不想写出一个烂摊子。我也想保持一切有序。从函数和变量命名，以及程序的粗略架构中，你可以看出这一点。不过，显然我没能做到。</p>
<p>混乱是逐渐产生的。更早的版本并不如此肮脏。例如下面的代码，那时候只支持 Boolean 参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="keyword">import</span> java.util.TreeSet;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String schema;</div><div class="line">    <span class="keyword">private</span> String[] args;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> valid;</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="keyword">new</span> TreeSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs = <span class="keyword">new</span> HashMap&lt;Character, Boolean&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> numberOfArguments = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        <span class="keyword">this</span>.args = args;</div><div class="line">        valid = parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; args.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        parseSchema();</div><div class="line">        parseArguments();</div><div class="line">        <span class="keyword">return</span> unexpectedArguments.size() == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) &#123;</div><div class="line">            parseSchemaElement(element);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (element.length() == <span class="number">1</span>) &#123;</div><div class="line">            parseBooleanSchemaElement(element);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(String element)</span> </span>&#123;</div><div class="line">        <span class="keyword">char</span> c = element.charAt(<span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (Character.isLetter(c)) &#123;</div><div class="line">            booleanArgs.put(c, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseArguments</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String arg : args) parseArgument(arg);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgument</span><span class="params">(String arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg.startsWith(<span class="string">"-"</span>)) parseElements(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElements</span><span class="params">(String arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arg.length(); i++) parseElement(arg.charAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isBoolean(argChar)) &#123;</div><div class="line">            numberOfArguments++;</div><div class="line">            setBooleanArg(argChar, <span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">else</span> unexpectedArguments.add(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanArgs.put(argChar, value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBoolean</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanArgs.containsKey(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">cardinality</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> numberOfArguments;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() &gt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="string">"-["</span> + schema + <span class="string">"]"</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (unexpectedArguments.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> unexpectedArgumentMessage();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">unexpectedArgumentMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        StringBuffer message = <span class="keyword">new</span> StringBuffer(<span class="string">"Argument( s) -"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : unexpectedArguments) &#123;</div><div class="line">            message.append(c);</div><div class="line">        &#125;</div><div class="line">        message.append(<span class="string">"unexpected."</span>);</div><div class="line">        <span class="keyword">return</span> message.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanArgs.get(arg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>尽管你可能对这段代码很不满意，其实它并非如此之烂。它精炼、简单、易于理解。然而，在这段代码中很容易找到后面烂摊子的根源。很清楚能看到小问题如何变成大混乱的。</p>
<p>注意，后来的混乱只比这个版本多支持两种参数类型 ：String 和 Integer。只增加了两种参数类型支持，就对代码产生了如此巨大的负面影响。它从某种可维护之物变成了满是缺陷的东西。</p>
<p>我逐步添加了对这两种参数类型的支持。</p>
<p>首先，我添加了对 String 参数的支持，就像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"><span class="keyword">import</span> java.util.TreeSet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.text.ParseException;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String schema;</div><div class="line">    <span class="keyword">private</span> String[] args;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="keyword">new</span> TreeSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs = <span class="keyword">new</span> HashMap&lt;Character, Boolean&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, String&gt; stringArgs = <span class="keyword">new</span> HashMap&lt;Character, String&gt;();</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentArgument;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgument = <span class="string">'\0'</span>;</div><div class="line"></div><div class="line">    <span class="keyword">enum</span> ErrorCode &#123;OK, MISSING_STRING&#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        <span class="keyword">this</span>.args = args;</div><div class="line">        valid = parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; args.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        parseSchema();</div><div class="line">        parseArguments();</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                String trimmedElement = element.trim();</div><div class="line">                parseSchemaElement(trimmedElement);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">        String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">        validateSchemaElementId(elementId);</div><div class="line">        <span class="keyword">if</span> (isBooleanSchemaElement(elementTail)) parseBooleanSchemaElement(elementId);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isStringSchemaElement(elementTail))</div><div class="line">            parseStringSchemaElement(elementId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Bad character:"</span> + elementId + <span class="string">"in Args format:"</span> + schema, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        stringArgs.put(elementId, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"*"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.length() == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        booleanArgs.put(elementId, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseArguments</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (currentArgument = <span class="number">0</span>; currentArgument &lt; args.length; currentArgument++) &#123;</div><div class="line">            String arg = args[currentArgument];</div><div class="line">            parseArgument(arg);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgument</span><span class="params">(String arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg.startsWith(<span class="string">"-"</span>)) parseElements(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElements</span><span class="params">(String arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arg.length(); i++) parseElement(arg.charAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (setArgument(argChar)) argsFound.add(argChar);</div><div class="line"></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            unexpectedArguments.add(argChar);</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> set = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (isBoolean(argChar)) setBooleanArg(argChar, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isString(argChar)) setStringArg(argChar, <span class="string">""</span>);</div><div class="line">        <span class="keyword">else</span> set = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">return</span> set;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(<span class="keyword">char</span> argChar, String s)</span> </span>&#123;</div><div class="line">        currentArgument++;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stringArgs.put(argChar, args[currentArgument]);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">            errorArgument = argChar;</div><div class="line">            errorCode = ErrorCode.MISSING_STRING;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isString</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringArgs.containsKey(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanArgs.put(argChar, value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBoolean</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanArgs.containsKey(argChar);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">cardinality</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.size();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="string">"-["</span> + schema + <span class="string">"]"</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (unexpectedArguments.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> unexpectedArgumentMessage();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">switch</span> (errorCode) &#123;</div><div class="line">            <span class="keyword">case</span> MISSING_STRING:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>, errorArgument);</div><div class="line">            <span class="keyword">case</span> OK:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"TILT: Should not get here."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">unexpectedArgumentMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        StringBuffer message = <span class="keyword">new</span> StringBuffer(<span class="string">"Argument( s) -"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : unexpectedArguments) &#123;</div><div class="line">            message.append(c);</div><div class="line">        &#125;</div><div class="line">        message.append(<span class="string">"unexpected."</span>);</div><div class="line">        <span class="keyword">return</span> message.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> falseIfNull(booleanArgs.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">falseIfNull</span><span class="params">(Boolean b)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> b == <span class="keyword">null</span> ? <span class="keyword">false</span> : b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> blankIfNull(stringArgs.get(arg));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">blankIfNull</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> s == <span class="keyword">null</span> ? <span class="string">""</span> : s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.contains(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以看到，代码开始失去控制。还算不上可怕，但混乱已经开始生长。已经出现了一堆东西，不过还没烂掉。增加对整数参数类型的支持后，那堆东西就真的变质腐烂了。</p>
<h3 id="所以我暂停了"><a href="#所以我暂停了" class="headerlink" title="所以我暂停了"></a>所以我暂停了</h3><p>还有至少两种参数类型要添加，而且情形一定会更加糟糕。如果一味蛮干，大概也能让它工作，不过就会留下一大堆要调整的混乱。如果希望代码结构一直可维护，现在就是调整的时机了。</p>
<p>所以我暂停添加特性，开始重构。由于刚添加了 String 和 Integer 参数，我知道每种参数类型都需要在三个主要位置增加新代码。首先，每种参数类型都要有解析其范式元素、从而为该种类型选择 HashMap 的方法。其次，每种参数类型都需要在命令行字符串中解析，然后再转换为真实类型。最后，每种参数类型都需要一个 getXXX 方法，按照其真实类型向调用者返回参数值。</p>
<p>许多种不同类型，类似的方法 - 听起来像是个类。ArgumentMarshaler 的概念就是这样产生的。</p>
<h3 id="渐进"><a href="#渐进" class="headerlink" title="渐进"></a>渐进</h3><p>毁坏程序的最好方法之一就是以改进之名大动其结构。有些程序永远不能从这种所谓“改进”中恢复过来。问题在于，很难让程序以“改进”之前的方式工作。</p>
<p>为了避免这种状况发生，我采用了测试驱动开发的规程。这种手法的核心原则之一是保持系统始终能运行。换言之，采用 TDD，我不会允许做出破坏系统的修改。每次修改都必须保证系统能像以前一样工作。</p>
<p>我需要一套能随需运行、确保系统行为不会改动的自动化测试。在我搞出那个烂摊子的同时，也为 Args 类创建了一套单元测试和验收测试。单元测试用 Java 写成，采用 JUnit 管理。验收测试用 FitNesse 以 wiki 页形式写成。我可以随时运行这些测试，如果测试通过，就能打包票说系统以我期望的方式工作。</p>
<p>于是我开始做出大量小规模修改。每次修改都将系统结构向 ArgumentMarshaler 概念的方向推动。而且每次修改后，系统都要能工作。第一个修改是在烂摊子末尾添加 ArgumentMarshaler 的轮廓。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoolean</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanValue = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，这什么也不会破坏。于是我做了一点最简单的、破坏性尽可能小的修改。我修改了 HashMap，采用 ArgumentMarshaler，使之支持 Boolean 参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; booleanArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div></pre></td></tr></table></figure>
<p>这个影响到少数语句，我很快就修正了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    booleanArgs.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">    booleanArgs.get(argChar).setBoolean(value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> falseIfNull(booleanArgs.get(arg).getBoolean());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意，这些修改正是在我之前提到的那些区域之内所做的：参数类型的 parse、set 和 get 操作。不幸的是，即便修改如此细微，有些测试还是会失败。仔细看 getBoolean，可以看到如果用 y 去调用、而并没有 y 这个参数，则 booleanArgs.get(‘y’) 就会返回 null 值，函数将抛出抛出一个 NullPointerException 异常。函数 falseIfNull 用以防止这种状况发生，但我做出的修改却导致该函数无所作为。</p>
<p>渐进主义要求我在做其他修改之前迅速修正这个问题。修正并不费劲。我只是把对 null 值的检查移了个位置。再也不用检测 bollean 是否为 null，而是检查 ArgumentMarshaler 是否为 null。</p>
<p>首先，我移除了 getBoolean 函数中的 falseIfNull 调用。现在它没什么用了，所以我也删去了这个函数。测试还是以同样的方式失败，所以我确定没有引入新的错误。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> booleanArgs.get(arg).getBoolean();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一步，我把函数拆解为两行，并把 ArgumentMarshaler 放到它自己的名为 argumentMarshaler 的变量中。我不在意变量名太长，但它却有点啰嗦，把函数搞得支离破碎。所以我把变量名缩短为 am。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaleram = booleanArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am.getBoolean();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后再放入检测 null 值的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaleram = booleanArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am != <span class="keyword">null</span> &amp;&amp; am.getBoolean();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="字符串参数"><a href="#字符串参数" class="headerlink" title="字符串参数"></a>字符串参数</h2><p>添加 String 参数和添加 Boolean 参数非常像。我要修改 HashMap，让 parse、set 和 get函数能工作。跟着就是按部就班，但我似乎该把所有的 marshalling（编组）实现放到 ArgumentMarshaler 基类而不是派生类中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; stringArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    stringArgs.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    currentArgument++;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        stringArgs.get(argChar).setString(args[currentArgument]);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        errorCode = ErrorCode.MISSING_ STRING;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = stringArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="string">""</span> : am.getString();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> String stringValue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoolean</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanValue = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        stringValue = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue == <span class="keyword">null</span> ? <span class="string">""</span> : stringValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样，也是每次修改一个地方，持续运行测试。如果测试出错，在做下一个修改前确保通过。</p>
<p>现在你应该明白我的意图了。一旦我将当前的编组行为放到 ArgumentMarshaler 基类中，就会开始往派生类推入该行为。这样，在我逐渐修改程序的形状时，还能保持一切正常。</p>
<p>下一步显而易见，把 int 参数的相关功能放到 ArgumentMarshaler 里面。同样，也是照方抓药。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; intArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseIntegerSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    intArgs.put(elementId, <span class="keyword">new</span></div><div class="line">            IntegerArgumentMarshaler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    currentArgument++;</div><div class="line">    String parameter = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        parameter = args[currentArgument];</div><div class="line">        intArgs.get(argChar).setInteger(Integer.parseInt(parameter));</div><div class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        errorCode = ErrorCode.MISSING_ INTEGER;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        errorParameter = parameter;</div><div class="line">        errorCode = ErrorCode.INVALID_ INTEGER;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = intArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="number">0</span> : am.getInteger();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> String stringValue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> integerValue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoolean</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanValue = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        stringValue = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue == <span class="keyword">null</span> ? <span class="string">""</span> : stringValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInteger</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        integerValue = i;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInteger</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> integerValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当所有的编组操作都放到了 ArgumentMarshaler 中，我开始向派生类移植功能。第一步是把 setBoolean 函数放到 BooleanArgumentMarshaler 中，确保它能正确调用。所以我创建了一个抽象的 set 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> String stringValue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> integerValue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoolean</span><span class="params">(<span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">        booleanValue = value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        stringValue = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue == <span class="keyword">null</span> ? <span class="string">""</span> : stringValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInteger</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        integerValue = i;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInteger</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> integerValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在 BooleanArgumentMarshaler 中实现 set 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        booleanValue = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，通过调用 set，替换对 setBoolean 的调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar, <span class="keyword">boolean</span> value)</span> </span>&#123;</div><div class="line">    booleanArgs.get(argChar).set(<span class="string">" true"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试仍然全部通过。因为这次修改导致 set 函数放到了 BooleanArgumentMarshaler 里面，我就从 ArgumentMarshaler 基类删除了 setBoolean 方法。</p>
<p>注意，抽象函数 set 有一个 String 参数，但其在 BooleanArgumentMarshaler 中的实现却没有使用这个参数。之所以在这里放个参数，是因为我知道 StringArgumentMarshaler 和 IntegerArgumentMarshaler 可能会使用它。</p>
<p>跟着，我打算把 get 方法放到 BooleanArgumentMarshaler 中。这有点难看，因为返回类型必须是 Object，且在这里需要转换为 Boolean 值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = booleanArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am != <span class="keyword">null</span> &amp;&amp; (Boolean) am.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了编译通过，我把 get 函数加到 ArgumentMarshaler 中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样一来，虽然可以编译，但却无法通过测试。只要将 get 修改为抽象方法，并在 BooleanArgumentMarshaler 中实现，就能重新通过测试。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">get</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        booleanValue = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试又通过了。get 和 set 方法都已部署到 BooleanArgumentMarshaler 中！这样我就可以从 ArgumentMarshaler 里面移除旧的 getBoolean 函数，把受保护的 booleanValue 变量向下移动到 BooleanArgumentMarshaler，并将其设置为 private。</p>
<p>对于 String 也照此办理。我修改了 set 和 get 的部署方式，删除无用的函数，并移动了变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    currentArgument++;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        stringArgs.get(argChar).set(args[currentArgument]);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        errorCode = ErrorCode.MISSING_STRING;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = stringArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="string">""</span> : (String) am.get();</div><div class="line">&#125;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> integerValue;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInteger</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        integerValue = i;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInteger</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> integerValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">get</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        booleanValue = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        stringValue = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我为 Integer 类型参数重复这个过程。这稍稍复杂一点，因为 Integer 需要解析，而 parse 操作会抛出异常。不过结果会更好，因为 NumberFormatException 的概念在 IntegerArgumentMarshaler 中隐藏了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intArgs.containsKey(argChar);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    currentArgument++;</div><div class="line">    String parameter = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        parameter = args[currentArgument];</div><div class="line">        intArgs.get(argChar).set(parameter);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        errorCode = ErrorCode.MISSING_INTEGER;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        errorParameter = parameter;</div><div class="line">        errorCode = ErrorCode.INVALID_INTEGER;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        booleanArgs.get(argChar).set(<span class="string">" true"</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = intArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="number">0</span> : (Integer) am.get();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> <span class="keyword">throws</span> ArgsException</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">get</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            intValue = Integer.parseInt(s);</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> intValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试当然继续通过。下一步，我要删掉算法顶端的三种不同 Map。这样，整个系统就变得更通用了。不过，只是删除它们却无法达到目的，因为那样会破坏系统。反之，我为 ArgumentMarshaler 添加一个新的 Map，然后再逐个修改那些方法，让方法调用这个新 Map。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; booleanArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; stringArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; intArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler m = <span class="keyword">new</span> BooleanArgumentMarshaler();</div><div class="line">        booleanArgs.put(elementId, m);</div><div class="line">        marshalers.put(elementId, m);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseIntegerSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler m = <span class="keyword">new</span> IntegerArgumentMarshaler();</div><div class="line">        intArgs.put(elementId, m);</div><div class="line">        marshalers.put(elementId, m);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler m = <span class="keyword">new</span> StringArgumentMarshaler();</div><div class="line">        stringArgs.put(elementId, m);</div><div class="line">        marshalers.put(elementId, m);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，测试还是通过了。接着，我把 isBooleanArg：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> booleanArgs.containsKey(argChar);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>修改成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">return</span> m <span class="keyword">instanceof</span> BooleanArgumentMarshaler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试仍然通过。于是我修改了一下 isIntArg 和 isStringArg。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">return</span> m <span class="keyword">instanceof</span> IntegerArgumentMarshaler;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">return</span> m <span class="keyword">instanceof</span> StringArgumentMarshaler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试继续通过。我跟着消除了对 marshaler.get() 的重复调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (isBooleanArg(m)) setBooleanArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isStringArg(m)) setStringArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isIntArg(m)) setIntArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntArg</span><span class="params">(ArgumentMarshaler m)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> m <span class="keyword">instanceof</span> IntegerArgumentMarshaler;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringArg</span><span class="params">(ArgumentMarshaler m)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> m <span class="keyword">instanceof</span> StringArgumentMarshaler;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanArg</span><span class="params">(ArgumentMarshaler m)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> m <span class="keyword">instanceof</span> BooleanArgumentMarshaler;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存在三个 isXxxArg 方法毫无道理。所以我做了内联修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler)</div><div class="line">        setBooleanArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler) setStringArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler) setIntArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一步，我开始在 set 函数中使用 marshaler 映射，停止使用另外三个映射映射。从 Boolean 开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler) setBooleanArg(m);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler) setStringArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span></div><div class="line">            IntegerArgumentMarshaler) setIntArg(argChar);</div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(ArgumentMarshaler m)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        m.set(<span class="string">" true"</span>); <span class="comment">// was: booleanArgs. get(argChar). set("true");</span></div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试通过，于是我如法炮制 String 和 Integer 参数。这样我就能把有些丑陋的异常管理代码整合到 setArgument 函数中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler) setBooleanArg(m);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler) setStringArg(m);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler) setIntArg(m);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(ArgumentMarshaler m)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    currentArgument++;</div><div class="line">    String parameter = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        parameter = args[currentArgument];</div><div class="line">        m.set(parameter);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">        errorCode = ErrorCode.MISSING_ INTEGER;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        errorParameter = parameter;</div><div class="line">        errorCode = ErrorCode.INVALID_ INTEGER;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(ArgumentMarshaler m)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    currentArgument++;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        m.set(args[currentArgument]);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">        errorCode = ErrorCode.MISSING_ STRING;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>离彻底删除那 3 个旧映射的时机越来越近了。首先，我需要修改 getBoolean 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = booleanArgs.get(arg);</div><div class="line">    <span class="keyword">return</span> am != <span class="keyword">null</span> &amp;&amp; (Boolean) am.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>修改成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">    <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        b = am != <span class="keyword">null</span> &amp;&amp; (Boolean) am.get();</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">        b = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后这个修改可能令人吃惊。为什么我会突然决定对付 ClassCastException ？原因是我有一组单元测试，还有用 FitNesse 编写的一组验收测试。FitNesse 测试确认，如果用非布尔值参数调用 getBoolean，应该返回 false。可单元测试的结果不是这样。而到此时为止，我一直只调用单元测试。</p>
<p>这次修改把另一个对 Boolean 映射的使用抽离了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    ArgumentMarshaler m = <span class="keyword">new</span> BooleanArgumentMarshaler();</div><div class="line">    <span class="comment">// booleanArgs.put(elementId, m);</span></div><div class="line">    marshalers.put(elementId, m);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如此我们就能删除 Boolean 映射。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="comment">// private Map&lt;Character, ArgumentMarshaler&gt; booleanArgs = new HashMap&lt;Character, ArgumentMarshaler&gt;();</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; stringArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; intArgs = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来，我用同样的手法处理 String 和 Integer 参数，对 Boolean 参数做了一点清理工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseIntegerSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</div><div class="line">    marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="string">""</span> : (String) am.get();</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">    Args.ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="number">0</span> : (Integer) am.get();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ...</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="comment">// private Map&lt;Character, ArgumentMarshaler&gt; stringArgs = new HashMap&lt;Character, ArgumentMarshaler&gt;();</span></div><div class="line">    <span class="comment">// private Map&lt;Character, ArgumentMarshaler&gt; intArgs = new HashMap&lt;Character, ArgumentMarshaler&gt;();</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着，由于那些 parse 方法没有太多事情可做，我对它们进行了内联修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">    <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">    String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">    validateSchemaElementId(elementId);</div><div class="line">    <span class="keyword">if</span> (isBooleanSchemaElement(elementTail)) marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isStringSchemaElement(elementTail)) marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (isIntegerSchemaElement(elementTail)) &#123;</div><div class="line">        marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(String.format(<span class="string">"Argument: %c has invalid format: %s."</span>, elementId, elementTail), <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>行了，下面来看看全景吧。Args 类的现状：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.text.ParseException;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String schema;</div><div class="line">    <span class="keyword">private</span> String[] args;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="keyword">new</span> TreeSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentArgument;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">        OK,</div><div class="line">        MISSING_STRING,</div><div class="line">        MISSING_INTEGER,</div><div class="line">        INVALID_INTEGER,</div><div class="line">        UNEXPECTED_ARGUMENT</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        <span class="keyword">this</span>.args = args;</div><div class="line">        valid = parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; args.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        parseSchema();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parseArguments();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                String trimmedElement = element.trim();</div><div class="line">                parseSchemaElement(trimmedElement);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">        String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">        validateSchemaElementId(elementId);</div><div class="line">        <span class="keyword">if</span> (isBooleanSchemaElement(elementTail)) marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isStringSchemaElement(elementTail))</div><div class="line">            marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isIntegerSchemaElement(elementTail)) &#123;</div><div class="line">            marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(String.format(<span class="string">"Argument: %c has invalid format: %s."</span>, elementId, elementTail), <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Bad character:"</span> + elementId + <span class="string">"in Args format: "</span> + schema, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"*"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.length() == <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntegerSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"#"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseArguments</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (currentArgument = <span class="number">0</span>; currentArgument &lt; args.length; currentArgument++) &#123;</div><div class="line">            String arg = args[currentArgument];</div><div class="line">            parseArgument(arg);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgument</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg.startsWith(<span class="string">"-"</span>)) parseElements(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElements</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arg.length(); i++) parseElement(arg.charAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (setArgument(argChar)) argsFound.add(argChar);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            unexpectedArguments.add(argChar);</div><div class="line">            errorCode = ErrorCode.UNEXPECTED_ARGUMENT;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler) setBooleanArg(m);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span></div><div class="line">                    StringArgumentMarshaler) setStringArg(m);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler) setIntArg(m);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">            errorArgumentId = argChar;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(ArgumentMarshaler m)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        currentArgument++;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = args[currentArgument];</div><div class="line">            m.set(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ErrorCode.INVALID_INTEGER;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(ArgumentMarshaler m)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        currentArgument++;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m.set(args[currentArgument]);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_STRING;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(ArgumentMarshaler m)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m.set(<span class="string">" true"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">cardinality</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.size();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="string">"-["</span> + schema + <span class="string">"]"</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (errorCode) &#123;</div><div class="line">            <span class="keyword">case</span> OK:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"TILT: Should not get here."</span>);</div><div class="line">            <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</div><div class="line">                <span class="keyword">return</span> unexpectedArgumentMessage();</div><div class="line">            <span class="keyword">case</span> MISSING_STRING:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>, errorArgumentId, errorParameter);</div><div class="line">            <span class="keyword">case</span> MISSING_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>, errorArgumentId);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">unexpectedArgumentMessage</span><span class="params">()</span> </span>&#123;</div><div class="line">        StringBuffer message = <span class="keyword">new</span> StringBuffer(<span class="string">"Argument( s) -"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : unexpectedArguments) &#123;</div><div class="line">            message.append(c);</div><div class="line">        &#125;</div><div class="line">        message.append(<span class="string">"unexpected."</span>);</div><div class="line">        <span class="keyword">return</span> message.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        Args.ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            b = am != <span class="keyword">null</span> &amp;&amp; (Boolean) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">            b = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        Args.ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="string">""</span> : (String) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        Args.ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="number">0</span> : (Integer) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.contains(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> <span class="keyword">throws</span> ArgsException</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">get</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">            booleanValue = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> booleanValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">            stringValue = s;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> stringValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                intValue = Integer.parseInt(s);</div><div class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> intValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>功夫费尽，还是有点失望。程序结构好了一点，但在代码顶端还是有那一堆变量；在 setArgument 里面还是有那么恐怖的类型转换操作；而且那些 set 函数真的很丑陋。就别提那些错误处理操作了。前头要做的事还很多。</p>
<p>我真想删除掉 setArgument 里面那些类型转换操作。我想要 setArgument 只简单地调用 ArgumentMarshaler.set()。这意味着我需要将 setIntArg、setStringArg 和 setBooleanArg 推到合适的 ArgumentMarshaler 派生类里面。不过这有个问题。</p>
<p>仔细看 setIntArg，你会发现，它使用了两个实体变量：args 和 currentArg。为了把 setIntArg 移到 BooleanArgumentMarshaler 里面，我得把这两个变量都作为函数参数传递过去。那种做法太烂了。我只想传递一个参数。幸运的事，有个简单的解决方法。可以把 args 数组转换为一个 list，并向 set 函数传递一个 Iterator。这花了我 10 步功夫，每次都通过了测试。不过我只想你展示结果。你应该能看出来每个小修改步骤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.objectmentor.utilities.args;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.text.ParseException;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String schema;</div><div class="line"></div><div class="line">    <span class="comment">// private String[] args;</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="keyword">new</span> TreeSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Iterator&lt;String&gt; currentArgument;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; argsList;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">        OK,</div><div class="line">        MISSING_STRING,</div><div class="line">        MISSING_INTEGER,</div><div class="line">        INVALID_INTEGER,</div><div class="line">        UNEXPECTED_ARGUMENT</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        argsList = Arrays.asList(args);</div><div class="line">        valid = parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; argsList.size() == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        parseSchema();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parseArguments();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ---</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseArguments</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (currentArgument = argsList.iterator(); currentArgument.hasNext(); ) &#123;</div><div class="line">            String arg = currentArgument.next();</div><div class="line">            parseArgument(arg);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ---</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(ArgumentMarshaler m)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            m.set(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ErrorCode.INVALID_INTEGER;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(ArgumentMarshaler m)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m.set(currentArgument.next());</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_STRING;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>是这些简单的修改让测试保持通过。现在我们可以开始把 set 函数移植到合适的派生类中了。第一步，我要在 setArgument 中作以下修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (m == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler)</div><div class="line">            setBooleanArg(m);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler)</div><div class="line">            setStringArg(m);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler)</div><div class="line">            setIntArg(m);</div><div class="line">        <span class="comment">// else return false;</span></div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个修改很重要，因我们想要彻底删除那条 if-else 语句。所以，需要把错误条件抽离。</p>
<p>现在可以开始移动 set 函数了。setBooleanArg 函数很小，就从它开始。目标是让 setBooleanArg 函数只与 BooleanArgumentMarshaler 有关。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">        <span class="keyword">if</span> (m == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler) setBooleanArg(m, currentArgument);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler) setStringArg(m);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler) setIntArg(m);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">            errorArgumentId = argChar;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ---</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(ArgumentMarshaler m, Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="comment">// try &#123;</span></div><div class="line">        m.set(<span class="string">"true"</span>);</div><div class="line">        <span class="comment">// &#125; catch (ArgsException e) &#123;</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们不是刚把那个异常处理放进去吗？放进拿出是重构过程中常见的事。小步幅和保持测试通过，意味着你会不断移动各种东西。重构有点像是解魔方。需要经过许多小步骤，才能达到较大目标。每一步都是下一步的基础。</p>
<p>为什么要在 setBooleanArg 根本不需要的情况下向其传递 Iterator 呢？因为 setIntArg和 setStringArg 需要！还因为我打算通过 ArgumentMarshaler 中的抽象方法部署这三个函数，需要将其传递给 setBooleanArg。</p>
<p>现在 setBooleanArg 没用了。如果 ArgumentMarshaler 中有个 set 函数，我们可以直接调用它。是时候打造那个函数了！第一步，在 ArgumentMarshaler 中添加抽象方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> <span class="keyword">throws</span> ArgsException</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">get</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，这会影响到所有派生类。所以，要逐个实现新方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        booleanValue = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="comment">// booleanValue = true;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> booleanValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        stringValue = s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            intValue = Integer.parseInt(s);</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> intValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在可以删除 setBooleanArg 了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (m == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler) m.set(currentArgument);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler) setStringArg(m);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler) setIntArg(m);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试全部通过，而且 set 函数也部署到 BooleanArgumentMarshaler 里面了！</p>
<p>现在就能对 String 和 Integer 参数的处理做同样的修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (m == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (m <span class="keyword">instanceof</span> BooleanArgumentMarshaler) m.set(currentArgument);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> StringArgumentMarshaler)</div><div class="line">            m.set(currentArgument);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m <span class="keyword">instanceof</span> IntegerArgumentMarshaler)</div><div class="line">            m.set(currentArgument);</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ---</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stringValue = currentArgument.next();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_STRING;</div><div class="line"></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            set(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ErrorCode.INVALID_INTEGER;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> intValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后一击：可以移除类型转换了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">    ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">    <span class="keyword">if</span> (m == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        m.set(currentArgument);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        valid = <span class="keyword">false</span>;</div><div class="line">        errorArgumentId = argChar;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在可以删除 IntegerArgumentMarshaler 中那些过时的函数，做一下清理了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">extends</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            intValue = Integer.parseInt(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ErrorCode.INVALID_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> intValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还可以把 ArgumentMarshaler 修改为接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException</span>;</div><div class="line"></div><div class="line">    <span class="function">Object <span class="title">get</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在来看看往这个结构中添加新的参数类型有多容易。只需要做少量修改，而且修改是被隔离的。首先，增加一个新的测试用例，检测 Double 参数是否正常工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSimpleDoublePresent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Args args = <span class="keyword">new</span> Args(<span class="string">"x##"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"42.3"</span>&#125;);</div><div class="line">    assertTrue(args.isValid());</div><div class="line">    assertEquals(<span class="number">1</span>, args.cardinality());</div><div class="line">    assertTrue(args.has(<span class="string">'x'</span>));</div><div class="line">    assertEquals(<span class="number">42.3</span>, args.getDouble(<span class="string">'x'</span>), .<span class="number">001</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后清理范式解析代码，为 Double 参数类型添加 ## 监测。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">    <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">    String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">    validateSchemaElementId(elementId);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (elementTail.length() == <span class="number">0</span>) marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"*"</span>)) marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"#"</span>)) marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"##"</span>)) marshalers.put(elementId, <span class="keyword">new</span> DoubleArgumentMarshaler());</div><div class="line">    <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(String.format(<span class="string">"Argument: %c has invalid format: %s."</span>, elementId, elementTail), <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一步，编写 DoubleArgumentMarshaler 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> doubleValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            doubleValue = Double.parseDouble(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ErrorCode.MISSING_DOUBLE;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ErrorCode.INVALID_DOUBLE;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> doubleValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就得添加一个新的 ErrorCode：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">    OK,</div><div class="line">    MISSING_STRING,</div><div class="line">    MISSING_INTEGER,</div><div class="line">    INVALID_INTEGER,</div><div class="line">    UNEXPECTED_ARGUMENT,</div><div class="line">    MISSING_DOUBLE,</div><div class="line">    INVALID_DOUBLE</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还需要一个 getDouble 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvalidDouble</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Args args = <span class="keyword">new</span> Args(<span class="string">"x##"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"Forty two"</span>&#125;);</div><div class="line">    assertFalse(args.isValid());</div><div class="line">    assertEquals(<span class="number">0</span>, args.cardinality());</div><div class="line">    assertFalse(args.has(<span class="string">'x'</span>));</div><div class="line">    assertEquals(<span class="number">0</span>, args.getInt(<span class="string">'x'</span>));</div><div class="line">    assertEquals(<span class="string">"Argument -x expects a double but was 'Forty two'."</span>, args.errorMessage());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//---</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (errorCode) &#123;</div><div class="line">        <span class="keyword">case</span> OK:</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"TILT: Should not get here."</span>);</div><div class="line">        <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</div><div class="line">            <span class="keyword">return</span> unexpectedArgumentMessage();</div><div class="line">        <span class="keyword">case</span> MISSING_STRING:</div><div class="line">            <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>,</div><div class="line">                    errorArgumentId);</div><div class="line">        <span class="keyword">case</span> INVALID_INTEGER:</div><div class="line">            <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>,</div><div class="line">                    errorArgumentId, errorParameter);</div><div class="line">        <span class="keyword">case</span> MISSING_INTEGER:</div><div class="line">            <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>, errorArgumentId);</div><div class="line">        <span class="keyword">case</span> INVALID_DOUBLE:</div><div class="line">            <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects a double but was '%s'."</span>, errorArgumentId, errorParameter);</div><div class="line">        <span class="keyword">case</span> MISSING_DOUBLE:</div><div class="line">            <span class="keyword">return</span> String.format(<span class="string">"Could not find double parameter for -%c."</span>, errorArgumentId);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试通过。下一个测试确保我们正确监测到遗漏的 Double 参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingDouble</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Args args = <span class="keyword">new</span> Args(<span class="string">"x##"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>&#125;);</div><div class="line">    assertFalse(args.isValid());</div><div class="line">    assertEquals(<span class="number">0</span>, args.cardinality());</div><div class="line">    assertFalse(args.has(<span class="string">'x'</span>));</div><div class="line">    assertEquals(<span class="number">0.0</span>, args.getDouble(<span class="string">'x'</span>), <span class="number">0.01</span>);</div><div class="line">    assertEquals(<span class="string">"Could not find double parameter for -x."</span>, args.errorMessage());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>测试如期通过。我们只是为了保持一切完整而编写的这个测试。</p>
<p>异常代码很丑陋，不该在 Args 类中存在。我们也抛出 ParseException，但那并不真的属于我们自己。那就把所有异常都塞到 ArgsException 类中，并将其移到它自己的模块里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">        OK,</div><div class="line">        MISSING_STRING,</div><div class="line">        MISSING_INTEGER,</div><div class="line">        INVALID_INTEGER,</div><div class="line">        UNEXPECTED_ARGUMENT,</div><div class="line">        MISSING_DOUBLE,</div><div class="line">        INVALID_DOUBLE</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</div><div class="line">    <span class="keyword">private</span> ArgsException.ErrorCode errorCode = ArgsException.ErrorCode.OK;</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; argsList;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        argsList = Arrays.asList(args);</div><div class="line">        valid = parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; argsList.size() == <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        parseSchema();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parseArguments();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> valid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(String.format(<span class="string">"Argument: %c has invalid format: %s."</span>, elementId, elementTail));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(</div><div class="line">                    <span class="string">"Bad character:"</span> + elementId + <span class="string">"in Args format: "</span> + schema);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (setArgument(argChar))</div><div class="line">            argsFound.add(argChar);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            unexpectedArguments.add(argChar);</div><div class="line">            errorCode = ArgsException.ErrorCode.UNEXPECTED_ARGUMENT;</div><div class="line">            valid = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stringValue = currentArgument.next();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ArgsException.ErrorCode.MISSING_STRING;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            intValue = Integer.parseInt(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ArgsException.ErrorCode.MISSING_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ArgsException.ErrorCode.INVALID_INTEGER;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> intValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">double</span> doubleValue = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        String parameter = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            parameter = currentArgument.next();</div><div class="line">            doubleValue = Double.parseDouble(parameter);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</div><div class="line">            errorCode = ArgsException.ErrorCode.MISSING_DOUBLE;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">            errorParameter = parameter;</div><div class="line">            errorCode = ArgsException.ErrorCode.INVALID_DOUBLE;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> doubleValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很好。现在，Args 抛出的唯一一个异常是 ArgsException。把 ArgsException 移到它自己的模块中，意味着我们能把大量杂七杂八的错误支持代码从 Args 模块转移到这个模块。</p>
<p>现在我们完全把异常和错误代码从 Args 模块中隔离出来了。为达到这一目标，大概做了 30 次小修改每次修改都保持测试通过。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateWithNoSchemaOrArguments</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Args args = <span class="keyword">new</span> Args(<span class="string">""</span>, <span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">        assertEquals(<span class="number">0</span>, args.cardinality());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithNoSchemaButWithOneArgument</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">""</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithNoSchemaButWithMultipleArguments</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">""</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"-y"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNonLetterSchema</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"*"</span>, <span class="keyword">new</span> String[]&#123;&#125;);</div><div class="line">            fail(<span class="string">"Args constructor should have thrown exception"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.INVALID_ARGUMENT_NAME, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'*'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvalidArgumentFormat</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"f~"</span>, <span class="keyword">new</span> String[]&#123;&#125;);</div><div class="line">            fail(<span class="string">"Args constructor should have throws exception"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.INVALID_FORMAT, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'f'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSimpleBooleanPresent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Args args = <span class="keyword">new</span> Args(<span class="string">"x"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>&#125;);</div><div class="line">        assertEquals(<span class="number">1</span>, args.cardinality());</div><div class="line">        assertEquals(<span class="keyword">true</span>, args.getBoolean(<span class="string">'x'</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSimpleStringPresent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Args args = <span class="keyword">new</span> Args(<span class="string">"x*"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"param"</span>&#125;);</div><div class="line">        assertEquals(<span class="number">1</span>, args.cardinality());</div><div class="line">        assertTrue(args.has(<span class="string">'x'</span>));</div><div class="line">        assertEquals(<span class="string">"param"</span>, args.getString(<span class="string">'x'</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingStringArgument</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"x*"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.MISSING_STRING, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSpacesInFormat</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Args args = <span class="keyword">new</span> Args(<span class="string">"x, y"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-xy"</span>&#125;);</div><div class="line">        assertEquals(<span class="number">2</span>, args.cardinality());</div><div class="line">        assertTrue(args.has(<span class="string">'x'</span>));</div><div class="line">        assertTrue(args.has(<span class="string">'y'</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSimpleIntPresent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Args args = <span class="keyword">new</span> Args(<span class="string">"x#"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"42"</span>&#125;);</div><div class="line">        assertEquals(<span class="number">1</span>, args.cardinality());</div><div class="line">        assertTrue(args.has(<span class="string">'x'</span>));</div><div class="line">        assertEquals(<span class="number">42</span>, args.getInt(<span class="string">'x'</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvalidInteger</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"x#"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"Forty two"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.INVALID_INTEGER, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">            assertEquals(<span class="string">"Forty two"</span>, e.getErrorParameter());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingInteger</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"x#"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.MISSING_INTEGER, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSimpleDoublePresent</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Args args = <span class="keyword">new</span> Args(<span class="string">"x##"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"42.3"</span>&#125;);</div><div class="line">        assertEquals(<span class="number">1</span>, args.cardinality());</div><div class="line">        assertTrue(args.has(<span class="string">'x'</span>));</div><div class="line">        assertEquals(<span class="number">42.3</span>, args.getDouble(<span class="string">'x'</span>), .<span class="number">001</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvalidDouble</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"x##"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>, <span class="string">"Forty two"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.INVALID_DOUBLE, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">            assertEquals(<span class="string">"Forty two"</span>, e.getErrorParameter());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingDouble</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">new</span> Args(<span class="string">"x##"</span>, <span class="keyword">new</span> String[]&#123;<span class="string">"-x"</span>&#125;);</div><div class="line">            fail();</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            assertEquals(ArgsException.ErrorCode.MISSING_DOUBLE, e.getErrorCode());</div><div class="line">            assertEquals(<span class="string">'x'</span>, e.getErrorArgumentId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsExceptionTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUnexpectedMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ArgsException e = <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, <span class="string">'x'</span>, <span class="keyword">null</span>);</div><div class="line">        assertEquals(<span class="string">"Argument -x unexpected."</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingStringMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ArgsException e = <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.MISSING_STRING, <span class="string">'x'</span>, <span class="keyword">null</span>);</div><div class="line">        assertEquals(<span class="string">"Could not find string parameter for -x."</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvalidIntegerMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ArgsException e = <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_INTEGER, <span class="string">'x'</span>, <span class="string">"Forty two"</span>);</div><div class="line">        assertEquals(<span class="string">"Argument -x expects an integer but was 'Forty two'."</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingIntegerMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ArgsException e = <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.MISSING_INTEGER, <span class="string">'x'</span>, <span class="keyword">null</span>);</div><div class="line">        assertEquals(<span class="string">"Could not find integer parameter for -x."</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInvalidDoubleMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ArgsException e = <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_DOUBLE, <span class="string">'x'</span>, <span class="string">"Forty two"</span>);</div><div class="line">        assertEquals(<span class="string">"Argument -x expects a double but was 'Forty two'."</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMissingDoubleMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ArgsException e = <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.MISSING_DOUBLE, <span class="string">'x'</span>, <span class="keyword">null</span>);</div><div class="line">        assertEquals(<span class="string">"Could not find double parameter for -x."</span>, e.errorMessage());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</div><div class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(message);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode, String errorParameter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode, <span class="keyword">char</span> errorArgumentId, String errorParameter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</div><div class="line">        <span class="keyword">this</span>.errorArgumentId = errorArgumentId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">getErrorArgumentId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> errorArgumentId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorArgumentId</span><span class="params">(<span class="keyword">char</span> errorArgumentId)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorArgumentId = errorArgumentId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorParameter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> errorParameter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorParameter</span><span class="params">(String errorParameter)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> ErrorCode <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> errorCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorCode</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (errorCode) &#123;</div><div class="line">            <span class="keyword">case</span> OK:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"TILT: Should not get here."</span>);</div><div class="line">            <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c unexpected."</span>, errorArgumentId);</div><div class="line">            <span class="keyword">case</span> MISSING_STRING:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>,</div><div class="line">                        errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>,</div><div class="line">                        errorArgumentId, errorParameter);</div><div class="line">            <span class="keyword">case</span> MISSING_INTEGER:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>,</div><div class="line">                        errorArgumentId);</div><div class="line">            <span class="keyword">case</span> INVALID_DOUBLE:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects a double but was '%s'."</span>,</div><div class="line">                        errorArgumentId, errorParameter);</div><div class="line">            <span class="keyword">case</span> MISSING_DOUBLE:</div><div class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find double parameter for -%c."</span>,</div><div class="line">                        errorArgumentId);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> ErrorCode &#123;</div><div class="line">        OK,</div><div class="line">        INVALID_FORMAT,</div><div class="line">        UNEXPECTED_ARGUMENT,</div><div class="line">        INVALID_ARGUMENT_NAME,</div><div class="line">        MISSING_STRING,</div><div class="line">        MISSING_INTEGER,</div><div class="line">        INVALID_INTEGER,</div><div class="line">        MISSING_DOUBLE,</div><div class="line">        INVALID_DOUBLE</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String schema;</div><div class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</div><div class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</div><div class="line">    <span class="keyword">private</span> Iterator&lt;String&gt; currentArgument;</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; argsList;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.schema = schema;</div><div class="line">        argsList = Arrays.asList(args);</div><div class="line">        parse();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        parseSchema();</div><div class="line">        parseArguments();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                parseSchemaElement(element.trim());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</div><div class="line">        String elementTail = element.substring(<span class="number">1</span>);</div><div class="line">        validateSchemaElementId(elementId);</div><div class="line">        <span class="keyword">if</span> (elementTail.length() == <span class="number">0</span>)</div><div class="line">            marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"*"</span>)) marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"#"</span>))</div><div class="line">            marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"##"</span>)) marshalers.put(elementId, <span class="keyword">new</span> DoubleArgumentMarshaler());</div><div class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_FORMAT, elementId, elementTail);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.INVALID_ARGUMENT_NAME, elementId, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArguments</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (currentArgument = argsList.iterator(); currentArgument.hasNext(); ) &#123;</div><div class="line">            String arg = currentArgument.next();</div><div class="line">            parseArgument(arg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgument</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (arg.startsWith(<span class="string">"-"</span>))</div><div class="line">            parseElements(arg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElements</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arg.length(); i++)</div><div class="line">            parseElement(arg.charAt(i));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (setArgument(argChar))</div><div class="line">            argsFound.add(argChar);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, argChar, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</div><div class="line">        ArgumentMarshaler m = marshalers.get(argChar);</div><div class="line">        <span class="keyword">if</span> (m == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m.set(currentArgument);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</div><div class="line">            e.setErrorArgumentId(argChar);</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">cardinality</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.size();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (schema.length() &gt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">return</span> <span class="string">"-["</span> + schema + <span class="string">"]"</span>;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">boolean</span> b = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            b = am != <span class="keyword">null</span> &amp;&amp; (Boolean) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">            b = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> b;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="string">""</span> : (String) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="number">0</span> : (Integer) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getDouble</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        ArgumentMarshaler am = marshalers.get(arg);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> am == <span class="keyword">null</span> ? <span class="number">0</span> : (Double) am.get();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0.0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> argsFound.contains(arg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对 Args 类所作的主要的修改是在监测部分。从 Args 里面取出了大量代码，放到 ArgsException 中。我们还把全部 ArgumentMarshaler 转移到了它们自己的文件夹中。优秀的软件设计，大都关乎分隔 - 创建合适的空间放置不同种类的代码。对关注面的分隔让代码更易于理解和维护。</p>
<p>特别有意思的是 ArgsException 中的 errorMessage 方法。显然，把错误信息格式化操作放在 Args 里面，违反了 SRP 原则。Args 应该只处理参数，不该去管错误信息的格式。然而，把错误信息格式化代码放到 ArgsException 中是否有道理呢？</p>
<p>实话说，这是种折衷做法。不打算用 ArgsException 提供的错误信息的用户会想自己写错误信息。但如果有备好的错误信息，其方便之处也并非鲜见。</p>
<p>现在，显然我们已经非常接近本章开始处所展示的最终解决方案了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>代码能工作还不够。能工作的代码经常会严重崩溃。满足于仅仅让代码能工作的程序员不够专业。他们会害怕没时间改进代码的结构和设计，我不敢苟同。没什么能比糟糕的代码给开发项目带来更深远和长期的损害了。进度可以重订，需求可以重新定义，团队动态可以修正。但糟糕的代码只是一直腐败发酵，无情地拖着团队的后腿。我无数次看到开发团队蹒跚前行，只因为他们匆匆搞出一片代码沼泽，从此之后命运再也不受自己控制。</p>
<p>当然，糟糕的代码可以清理。不过成本高昂。随着代码腐败下去，模块之间互相渗透，出现大量隐藏纠结的依赖关系。找到和破除陈旧的依赖关系又费时间又费劲。另一方面，保持代码整洁却相对容易。早晨在模块中制造出一堆混乱，下午就能轻易清理掉。更好的情况是，5 分钟之前制造出混乱，马上就能很容易地清理掉。</p>
<p>所以，解决之道就是保持代码持续整洁和简单。永不让腐坏有机会开始。</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>Comments:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                   
                        <li>
                            <a href="https://github.com/ChinaSunHZ/" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="http://weibo.com/shz272119494" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://twitter.com/ChinaSunHZ" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://www.facebook.com/ChinaSunHZ" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://cn.linkedin.com/in/浩臻-孙-0208ba94" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="mailto:China.SunhZ@Gmail.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <!--
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
                -->
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="http://7xjqw5.com1.z0.glb.clouddn.com/theme/js/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="http://7xjqw5.com1.z0.glb.clouddn.com/theme/js/bootstrap-3.3.6.min.js"></script>

<!-- Gallery -->
<script src="http://7xjqw5.com1.z0.glb.clouddn.com/theme/js/featherlight-1.3.5.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'spencer-dev-com';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>